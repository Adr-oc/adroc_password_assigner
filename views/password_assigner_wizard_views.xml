<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Wizard Form View -->
    <record id="view_password_assigner_wizard_form" model="ir.ui.view">
        <field name="name">password.assigner.wizard.form</field>
        <field name="model">password.assigner.wizard</field>
        <field name="arch" type="xml">
            <form string="Asignar Contraseñas de Pago">
                <field name="state" invisible="1"/>
                <field name="company_id" invisible="1"/>

                <!-- Header with state info -->
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="upload,preview,done"/>
                </header>

                <sheet>
                    <!-- UPLOAD STATE -->
                    <div invisible="state != 'upload'" class="oe_title mb-4">
                        <h2>
                            <i class="fa fa-cloud-upload me-2 text-primary"/>
                            Subir Documentos
                        </h2>
                        <p class="text-muted">Suba imágenes, PDFs o archivos Excel con información de contraseñas de pago.</p>
                    </div>

                    <group invisible="state != 'upload'">
                        <group string="Documentos" class="col-12">
                            <field name="document_ids" widget="many2many_binary"
                                   string="Archivos"
                                   class="oe_inline"
                                   help="Formatos soportados: JPG, PNG, PDF, XLSX, XLS, CSV"/>
                        </group>
                        <group string="Configuración de Procesamiento">
                            <field name="config_id"
                                   placeholder="Seleccione configuración de IA..."
                                   options="{'no_create': True}"
                                   required="1"/>
                            <field name="template_id"
                                   placeholder="Solo para archivos Excel..."
                                   options="{'no_create': True}"/>
                        </group>
                    </group>

                    <!-- PROCESSING STATE -->
                    <div invisible="state != 'processing'" class="text-center py-5">
                        <i class="fa fa-spinner fa-spin fa-3x text-primary"/>
                        <h3 class="mt-3">Procesando documentos...</h3>
                        <p class="text-muted">La IA está analizando los documentos. Por favor espere.</p>
                    </div>

                    <!-- PREVIEW STATE -->
                    <div invisible="state != 'preview'">
                        <!-- Title -->
                        <div class="oe_title mb-3">
                            <h2>
                                <i class="fa fa-list-alt me-2 text-info"/>
                                Resultados del Análisis
                            </h2>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="d-flex gap-3 mb-4 flex-wrap">
                            <div class="card text-center" style="min-width: 120px;">
                                <div class="card-body py-2 px-3">
                                    <div class="h3 mb-0 text-primary">
                                        <field name="total_documents" readonly="1" class="d-inline"/>
                                    </div>
                                    <small class="text-muted">Documentos</small>
                                </div>
                            </div>
                            <div class="card text-center" style="min-width: 120px;">
                                <div class="card-body py-2 px-3">
                                    <div class="h3 mb-0 text-info">
                                        <field name="total_passwords" readonly="1" class="d-inline"/>
                                    </div>
                                    <small class="text-muted">Contraseñas</small>
                                </div>
                            </div>
                            <div class="card text-center border-success" style="min-width: 120px;">
                                <div class="card-body py-2 px-3">
                                    <div class="h3 mb-0 text-success">
                                        <field name="total_matched" readonly="1" class="d-inline"/>
                                    </div>
                                    <small class="text-muted">Encontradas</small>
                                </div>
                            </div>
                            <div class="card text-center border-warning" style="min-width: 120px;">
                                <div class="card-body py-2 px-3">
                                    <div class="h3 mb-0 text-warning">
                                        <field name="total_unmatched" readonly="1" class="d-inline"/>
                                    </div>
                                    <small class="text-muted">Sin Match</small>
                                </div>
                            </div>
                            <div class="card text-center border-primary" style="min-width: 120px;">
                                <div class="card-body py-2 px-3">
                                    <div class="h3 mb-0 text-primary">
                                        <field name="total_to_apply" readonly="1" class="d-inline"/>
                                    </div>
                                    <small class="text-muted">A Aplicar</small>
                                </div>
                            </div>
                        </div>

                        <!-- Error messages -->
                        <div class="alert alert-danger mb-3" invisible="not error_message">
                            <i class="fa fa-exclamation-triangle me-2"/>
                            <strong>Errores:</strong>
                            <field name="error_message" readonly="1" nolabel="1"/>
                        </div>

                        <!-- Selection buttons at top -->
                        <div class="mb-2 d-flex gap-2">
                            <button name="action_select_all" type="object"
                                    string="Seleccionar Todos" class="btn btn-outline-primary btn-sm">
                                <i class="fa fa-check-square-o me-1"/>
                            </button>
                            <button name="action_deselect_all" type="object"
                                    string="Deseleccionar Todos" class="btn btn-outline-secondary btn-sm">
                                <i class="fa fa-square-o me-1"/>
                            </button>
                        </div>

                        <!-- Preview lines -->
                        <field name="line_ids" nolabel="1">
                            <list editable="bottom"
                                  decoration-danger="match_status == 'not_found'"
                                  decoration-warning="match_status == 'multiple'"
                                  decoration-success="match_status == 'matched'">
                                <field name="apply" widget="boolean_toggle" string=""/>
                                <field name="password" string="Contraseña"/>
                                <field name="invoice_number_extracted" string="# Extraído"/>
                                <field name="amount_extracted" string="Monto" optional="show"/>
                                <field name="invoice_ids" widget="many2many_tags"
                                       string="Facturas"
                                       options="{'no_create': True}"
                                       domain="[('move_type', 'in', ['out_invoice', 'out_refund']), ('state', '=', 'posted')]"/>
                                <field name="invoice_count" string="#"/>
                                <field name="match_status" widget="badge" string="Estado"
                                       decoration-success="match_status == 'matched'"
                                       decoration-warning="match_status in ('partial', 'multiple')"
                                       decoration-danger="match_status == 'not_found'"
                                       decoration-info="match_status == 'manual'"/>
                                <field name="source_document" string="Origen" optional="hide"/>
                                <field name="invoice_series_extracted" string="Serie" optional="hide"/>
                                <field name="match_confidence" widget="progressbar" string="%" optional="hide"/>
                                <field name="notes" string="Notas" optional="hide"/>
                                <button name="action_open_invoices" type="object"
                                        icon="fa-external-link" title="Ver Facturas"
                                        class="btn-link p-0"/>
                            </list>
                        </field>
                    </div>

                    <!-- DONE STATE -->
                    <div invisible="state != 'done'" class="text-center py-5">
                        <div class="mb-4">
                            <i class="fa fa-check-circle fa-5x text-success"/>
                        </div>
                        <h2 class="text-success">¡Contraseñas Asignadas!</h2>
                        <p class="lead text-muted mt-3">
                            Se procesaron exitosamente las contraseñas seleccionadas.
                        </p>
                    </div>

                    <!-- Processing Log (collapsible) -->
                    <details invisible="not processing_log" class="mt-4">
                        <summary class="btn btn-link text-muted p-0">
                            <i class="fa fa-terminal me-1"/> Ver Log de Procesamiento
                        </summary>
                        <div class="mt-2 p-3 bg-dark text-light rounded" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                            <field name="processing_log" readonly="1" nolabel="1" widget="text"/>
                        </div>
                    </details>
                </sheet>

                <footer>
                    <!-- Upload state buttons -->
                    <button name="action_process_documents" type="object"
                            string="Procesar Documentos" class="btn-primary"
                            invisible="state != 'upload'">
                        <i class="fa fa-cogs me-1"/>
                    </button>
                    <button name="action_close" type="object"
                            string="Cancelar" class="btn-secondary"
                            invisible="state != 'upload'"/>

                    <!-- Preview state buttons -->
                    <button name="action_apply_passwords" type="object"
                            string="Aplicar Contraseñas" class="btn-primary"
                            invisible="state != 'preview'">
                        <i class="fa fa-check me-1"/>
                    </button>
                    <button name="action_back_to_upload" type="object"
                            string="Volver" class="btn-secondary"
                            invisible="state != 'preview'">
                        <i class="fa fa-arrow-left me-1"/>
                    </button>
                    <button name="action_close" type="object"
                            string="Cancelar" class="btn-secondary"
                            invisible="state != 'preview'"/>

                    <!-- Done state buttons -->
                    <button name="action_back_to_upload" type="object"
                            string="Procesar Más" class="btn-primary"
                            invisible="state != 'done'">
                        <i class="fa fa-plus me-1"/>
                    </button>
                    <button name="action_close" type="object"
                            string="Cerrar" class="btn-secondary"
                            invisible="state != 'done'"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Server Action to open wizard from account.move list -->
    <record id="action_password_assigner_wizard" model="ir.actions.act_window">
        <field name="name">Asignar Contraseñas</field>
        <field name="res_model">password.assigner.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
    </record>

</odoo>
